@@ -49,63 +49,82 @@
        #toast-notification.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        #chatbox::-webkit-scrollbar { width: 6px; }
        #chatbox::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        #chatbox::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px;}
        #chatbox::-webkit-scrollbar-thumb:hover { background: #aaa; }
        *:focus-visible { outline: 2px solid #4f46e5; outline-offset: 2px; border-radius: 4px; }
        *:focus:not(:focus-visible) { outline: none; }
        #addReminderFormContainer { display: none; }
        #addReminderFormContainer.active { display: block; }
        /* Removed Auth Container related styles */
        /* #auth-container { padding: 20px; text-align: center; margin-top: 40px; } */
        /* #user-info { margin-bottom: 15px; } */
        /* #login-button, #logout-button { background-color: #4f46e5; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.2s ease-in-out; display: inline-block; margin: 5px; border: none; cursor: pointer;} */
        /* #login-button:hover, #logout-button:hover { background-color: #4338ca; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); } */
        /* .logged-out main, .logged-out #bottom-nav { display: none; } */ /* Removed */
        /* .logged-in #auth-container { display: none; } */ /* Removed */
        /* .logged-out #user-auth-controls { display: none; } */ /* Removed */
        /* .logged-in #user-auth-controls { display: block; } */ /* Removed */

    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <header class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-6xl mx-auto px-4">
            <h1 class="text-xl font-semibold text-center tracking-wide flex-grow">SNG Finance</h1>
            <button id="logout-button" class="hidden bg-white text-indigo-600 font-medium px-3 py-1 rounded">Logout</button>
            </div>
    </header>

    <main class="p-5">
<div id="auth-section" class="p-5">
  <form id="login-form" class="space-y-4">
    <h2 class="text-lg font-semibold">Login</h2>
    <input id="login-username" type="text" placeholder="Username" class="w-full border p-2 rounded">
    <input id="login-password" type="password" placeholder="Password" class="w-full border p-2 rounded">
    <label class="inline-flex items-center"><input id="remember-day" type="checkbox" class="mr-2"> Remember for the day</label>
    <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded">Login</button>
    <p class="text-center"><a href="#" id="show-register" class="text-indigo-600">Create an account</a></p>
  </form>
  <form id="register-form" class="space-y-4 hidden mt-6">
    <h2 class="text-lg font-semibold">Create Account</h2>
    <input id="register-nickname" type="text" placeholder="Nick name" class="w-full border p-2 rounded">
    <input id="register-username" type="text" placeholder="Username (optional)" class="w-full border p-2 rounded">
    <input id="register-password" type="password" placeholder="Password" class="w-full border p-2 rounded">
    <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded">Sign Up</button>
    <p class="text-center"><a href="#" id="show-login" class="text-indigo-600">Back to login</a></p>
  </form>
</div>
    <main class="p-5 hidden">
        <section id="dashboard" class="app-section space-y-6"> <h2 class="text-2xl font-semibold text-slate-900 mb-5">Dashboard</h2> <div class="grid grid-cols-1 md:grid-cols-3 gap-5"> <div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-200"> <div class="flex items-center mb-3"> <svg class="h-6 w-6 text-emerald-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg> <h3 class="font-semibold text-slate-700">Debit Card</h3> </div> <p id="balance-debit" class="text-3xl font-bold text-slate-800">$0.00</p> <p class="text-sm text-slate-500 mt-1">Available Balance</p> </div> <div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-200"> <div class="flex items-center mb-3"> <svg class="h-6 w-6 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg> <h3 class="font-semibold text-slate-700">Personal Credit Card</h3> </div> <p id="balance-personal_cc" class="text-3xl font-bold balance-ok">$0.00</p> <p class="text-sm text-slate-500 mt-1">Amount Owed</p> </div> <div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-200"> <div class="flex items-center mb-3"> <svg class="h-6 w-6 text-purple-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg> <h3 class="font-semibold text-slate-700">Parent's Credit Card</h3> </div> <p id="balance-parent_cc" class="text-3xl font-bold balance-ok">$0.00 <span class="text-base font-normal text-slate-500">/ $500 Limit</span></p> <p class="text-sm text-slate-500 mt-1">Amount Owed</p> <div class="w-full bg-slate-200 rounded-full h-3 mt-3"> <div id="limitBar-parent_cc" class="h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div> </div> </div> </div> <div class="flex justify-around space-x-4 mt-8"> <button onclick="prepareTransactionForm('income')" class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out transform hover:-translate-y-0.5">Add Income</button> <button onclick="prepareTransactionForm('expense')" class="flex-1 text-center bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out transform hover:-translate-y-0.5">Add Expense</button> </div> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mt-8"> <h3 class="font-semibold text-slate-700 mb-4">Recent Transactions</h3> <ul id="recentTransactionList" class="space-y-3"> <li class="text-slate-500 italic">No transactions yet.</li> </ul> <button class="text-indigo-600 hover:text-indigo-700 mt-4 text-sm font-medium w-full text-center" onclick="navigateTo('transactions')">View All Transactions</button> </div> </section>
        <section id="transactions" class="app-section space-y-6"> <h2 class="text-2xl font-semibold text-slate-900 mb-5">Manage Transactions</h2> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 id="transactionFormTitle" class="text-lg font-semibold text-slate-800 mb-4">Add New Transaction</h3> <form id="addTransactionForm" class="space-y-4"> <input type="hidden" id="transactionId" name="transactionId"> <div> <label for="description" class="block text-sm font-medium text-slate-700 mb-1">Description</label> <input type="text" id="description" name="description" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"> </div> <div> <label for="amount" class="block text-sm font-medium text-slate-700 mb-1">Amount</label> <input type="number" id="amount" name="amount" step="0.01" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Income is positive, Expense is negative"> </div> <div> <label for="category" class="block text-sm font-medium text-slate-700 mb-1">Category</label> <select id="category" name="category" required class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"> <option value="food">Food</option> <option value="transport">Transport</option> <option value="entertainment">Entertainment</option> <option value="subscriptions">Subscriptions</option> <option value="shopping">Shopping</option> <option value="bills">Bills</option> <option value="rent">Rent</option> <option value="income">Income / CC Payment</option> <option value="other">Other Expense</option> </select> </div> <div> <label for="account" class="block text-sm font-medium text-slate-700 mb-1">Account</label> <select id="account" name="account" required class="block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"> <option value="debit">Debit Card</option> <option value="personal_cc">Personal Credit Card</option> <option value="parent_cc">Parent's Credit Card</option> </select> </div> <div> <label for="date" class="block text-sm font-medium text-slate-700 mb-1">Date</label> <input type="date" id="date" name="date" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"> </div> <button id="saveTransactionBtn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out mt-3">Save Transaction</button> <button id="cancelEditBtn" type="button" onclick="resetTransactionForm()" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out mt-2 hidden">Cancel Edit</button> </form> </div> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="text-lg font-semibold text-slate-800 mb-4">History</h3> <ul id="transactionList" class="space-y-4"> <li class="text-slate-500 italic">No transactions recorded yet.</li> </ul> </div> </section>
        <section id="budget" class="app-section space-y-6"> <h2 class="text-2xl font-semibold text-slate-900 mb-5">Budget Tracker</h2> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="font-semibold text-slate-700 mb-3">Monthly Expenses</h3> <p id="monthlySpendingSummary" class="text-3xl font-bold text-slate-800">$0.00 <span class="text-lg font-normal text-slate-500">/ $1800 Budget</span></p> <div class="w-full bg-slate-200 rounded-full h-4 mt-4"> <div id="overallBudgetBar" class="bg-blue-500 h-4 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div> </div> </div> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="font-semibold text-slate-700 mb-4 text-center">Expense Breakdown</h3> <div class="w-full max-w-xs mx-auto"> <canvas id="spendingPieChart"></canvas> </div> </div> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="font-semibold text-slate-700 mb-4">Category Budgets</h3> <ul id="categoryBudgetList" class="space-y-5"></ul> <button class="w-full mt-6 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2.5 px-4 rounded-lg border border-slate-300 transition duration-200 ease-in-out">Manage Budgets (Future)</button> </div> </section>
        <section id="reminders" class="app-section space-y-6"> <h2 class="text-2xl font-semibold text-slate-900 mb-5">Payment Reminders</h2> <button onclick="toggleReminderForm(true)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out mb-5 transform hover:-translate-y-0.5">Add New Reminder</button> <div id="addReminderFormContainer" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6"> <h3 id="reminderFormTitle" class="text-lg font-semibold text-slate-800 mb-4">Add Reminder</h3> <form id="addReminderForm" class="space-y-4"> <input type="hidden" id="reminderId" name="reminderId"> <div> <label for="reminderDescription" class="block text-sm font-medium text-slate-700 mb-1">Description</label> <input type="text" id="reminderDescription" name="description" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"> </div> <div> <label for="reminderDueDate" class="block text-sm font-medium text-slate-700 mb-1">Due Date</label> <input type="date" id="reminderDueDate" name="dueDate" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"> </div> <div class="flex space-x-3"> <button id="saveReminderBtn" type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out mt-1">Save Reminder</button> <button id="cancelReminderEditBtn" type="button" onclick="toggleReminderForm(false); resetReminderForm();" class="flex-1 bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out mt-1">Cancel</button> </div> </form> </div> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="text-lg font-semibold text-slate-800 mb-4">Upcoming Reminders</h3> <ul id="reminderList" class="space-y-4"> <li class="text-slate-500 italic">No reminders set yet.</li> </ul> </div> </section>
        <section id="advice" class="app-section space-y-6"> <h2 class="text-2xl font-semibold text-slate-900 mb-5">Financial Advice & Tips</h2> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="font-semibold text-emerald-700 mb-3">Personalized Advice (Example)</h3> <p class="text-slate-700 leading-relaxed">Based on your spending, consider exploring student discounts...</p> </div> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="font-semibold text-blue-700 mb-3">Credit Score Improvement Tips</h3> <ul class="list-disc list-inside space-y-2 text-slate-700 leading-relaxed"><li>Always pay bills on time...</li></ul> </div> <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"> <h3 class="font-semibold text-purple-700 mb-3">Boston Student Resources</h3> <ul class="list-disc list-inside space-y-2 text-slate-700 leading-relaxed"><li>Check financial aid office...</li></ul> </div> </section>
        <section id="chatbot" class="app-section space-y-5"> <h2 class="text-2xl font-semibold text-slate-900 mb-5">AI Financial Assistant</h2> <div id="chatbox" class="h-96 overflow-y-auto border border-slate-200 p-4 rounded-xl bg-white shadow-sm space-y-4 flex flex-col"> <div class="chat-bubble chat-bubble-bot">Hello! Ask me how to save money...</div> </div> <div class="flex space-x-3"> <input type="text" id="chatInput" class="flex-grow px-4 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ask me anything..."> <button id="sendChat" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition duration-200 ease-in-out">Send</button> </div> </section>
    </main>

    <nav id="bottom-nav" class="grid grid-cols-6 border-t border-slate-200">
    <nav id="bottom-nav" class="hidden grid grid-cols-6 border-t border-slate-200">
        <button onclick="navigateTo('dashboard')" class="nav-item flex flex-col items-center justify-center py-2 px-1 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200" data-target="dashboard"> <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs font-medium">Home</span></button>
        <button onclick="navigateTo('transactions')" class="nav-item flex flex-col items-center justify-center py-2 px-1 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200" data-target="transactions"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg><span class="text-xs font-medium">History</span></button>
        <button onclick="navigateTo('budget')" class="nav-item flex flex-col items-center justify-center py-2 px-1 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200" data-target="budget"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg><span class="text-xs font-medium">Budget</span></button>
        <button onclick="navigateTo('reminders')" class="nav-item flex flex-col items-center justify-center py-2 px-1 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200" data-target="reminders"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg><span class="text-xs font-medium">Reminders</span></button>
        <button onclick="navigateTo('advice')" class="nav-item flex flex-col items-center justify-center py-2 px-1 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200" data-target="advice"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg><span class="text-xs font-medium">Advice</span></button>
        <button onclick="navigateTo('chatbot')" class="nav-item flex flex-col items-center justify-center py-2 px-1 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition-colors duration-200" data-target="chatbot"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span class="text-xs font-medium">Chatbot</span></button>
    </nav>

    <div id="toast-notification"></div>

    <script>
        // Add this near the beginning of your script section in index.html

// Function to check PWA cache status
async function checkPwaReadiness() {
    try {
        // First check if service worker is active
        if (!('serviceWorker' in navigator)) {
            console.log('Service Workers not supported');
            return false;
        }
        
        if (!navigator.serviceWorker.controller) {
            console.log('No active service worker found');
            return false;
@@ -160,50 +179,163 @@ if (window.matchMedia('(display-mode: standalone)').matches) {
        const firebaseConfig = {
            apiKey: "AIzaSyBiGFtbpGto5ZtyliohDkgUyEawKfQFeOk", // Replace with your actual API key
            authDomain: "boston-student-finance.firebaseapp.com",
            projectId: "boston-student-finance",
            storageBucket: "boston-student-finance.appspot.com", // Corrected: was .appspot.com, should be .app
            messagingSenderId: "547176457645",
            appId: "1:547176457645:web:f3dc7064ba8b94ac5d2d24"
        };

        // --- Initialize Firebase ---
        let app;
        let db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            db = firebase.firestore();
            console.log("Firebase initialized (App and Firestore only)");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showToast("Error connecting to backend.", 5000);
        }

        // --- Simple Authentication ---
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const logoutButton = document.getElementById('logout-button');

        function showAuth() {
            authSection.classList.remove('hidden');
            document.querySelector('main').classList.add('hidden');
            logoutButton.classList.add('hidden');
        }
        function showApp() {
            authSection.classList.add('hidden');
            document.querySelector('main').classList.remove('hidden');
            logoutButton.classList.remove('hidden');
        }

        function saveRemember(username) {
            const expiry = new Date();
            expiry.setHours(23,59,59,999);
            localStorage.setItem('rememberUser', JSON.stringify({ username, expiry: expiry.getTime() }));
        }
        function loadRemember() {
            const item = localStorage.getItem('rememberUser');
            if (!item) return null;
            const data = JSON.parse(item);
            if (Date.now() > data.expiry) { localStorage.removeItem('rememberUser'); return null; }
            return data.username;
        }

        function getStoredAccounts() {
            const data = localStorage.getItem('localAccounts');
            return data ? JSON.parse(data) : {};
        }
        function saveStoredAccounts(acc) {
            localStorage.setItem('localAccounts', JSON.stringify(acc));
        }

        async function loginUser(username, password, remember) {
            try {
                let account;
                if (db) {
                    const doc = await db.collection('userAccounts').doc(username).get();
                    if (!doc.exists) { showToast('User not found'); return; }
                    if (doc.data().password !== password) { showToast('Incorrect password'); return; }
                    account = doc.data();
                } else {
                    const accounts = getStoredAccounts();
                    if (!accounts[username]) { showToast('User not found'); return; }
                    if (accounts[username].password !== password) { showToast('Incorrect password'); return; }
                    account = accounts[username];
                }
                currentUserId = username;
                if (remember) saveRemember(username); else localStorage.removeItem('rememberUser');
                showApp();
                setupFirestoreListeners();
            } catch (e) { console.error(e); showToast('Login error'); }
        }

        async function createAccount(nick, username, password) {
            username = username || nick;
            try {
                if (db) {
                    await db.collection('userAccounts').doc(username).set({ nickname: nick, username, password });
                } else {
                    const accounts = getStoredAccounts();
                    if (accounts[username]) { showToast('Account already exists'); return; }
                    accounts[username] = { nickname: nick, password };
                    saveStoredAccounts(accounts);
                }
                showToast('Account created. Please log in.');
                registerForm.reset();
                showAuthForms(true);
            } catch (e) { console.error(e); showToast('Account creation failed'); }
        }

        function logoutUser() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeReminders) unsubscribeReminders();
            currentUserId = null;
            localStorage.removeItem('rememberUser');
            showAuth();
        }

        function showAuthForms(isLogin) {
            if (isLogin) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
        }

        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showAuthForms(false); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthForms(true); });
        logoutButton.addEventListener('click', logoutUser);
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('login-username').value.trim();
            const pass = document.getElementById('login-password').value;
            const remember = document.getElementById('remember-day').checked;
            if (user && pass) loginUser(user, pass, remember);
        });
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nick = document.getElementById('register-nickname').value.trim();
            const user = document.getElementById('register-username').value.trim();
            const pass = document.getElementById('register-password').value;
            if (nick && pass) createAccount(nick, user || nick, pass);
        });
        // --- PWA Service Worker Registration ---
        // Updated service worker registration that won't show the offline message incorrectly
// Replace your current service worker registration code with this improved version
// that won't show any error messages

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', { scope: '/' })
            .then(reg => {
                console.log('ServiceWorker registration successful. Scope:', reg.scope);
                
                // Check for updates to the service worker
                reg.update().catch(err => {
                    console.warn('Service worker update check failed:', err);
                    // Don't show toast to user - this is a background process
                });
                
                // Handle controller change (when a new service worker takes over)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('New service worker controller activated');
                });
            })
            .catch(err => {
                // Just log errors to console - don't show to user
                console.error('ServiceWorker registration failed:', err);
@@ -352,61 +484,61 @@ function initializeOfflineMode() {
        // const cancelReminderButton = document.getElementById('cancelReminderEditBtn'); // Already handled by inline onclick
        const reminderDescriptionInput = document.getElementById('reminderDescription');
        const reminderDueDateInput = document.getElementById('reminderDueDate');
        const reminderIdInput = document.getElementById('reminderId');

        function toggleReminderForm(show = true) {
            if (show) {
                reminderFormContainer.classList.add('active');
                resetReminderForm();
                reminderDescriptionInput.focus();
            } else {
                reminderFormContainer.classList.remove('active');
            }
        }
        function resetReminderForm() {
            reminderForm.reset();
            editingReminderId = null;
            reminderIdInput.value = '';
            reminderFormTitle.textContent = 'Add Reminder';
            saveReminderButton.textContent = 'Save Reminder';
            saveReminderButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            saveReminderButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        }

        // --- Firebase Data Functions ---
        const GENERIC_USER_ID = "sharedUserData"; // Static ID for single-user mode
        let currentUserId = null;

        function getUserCollectionRef(collectionName) {
            if (!db) {
                console.error("Firestore (db) is not initialized!");
                showToast("Data backend not ready.", 3000);
                return null;
            }
            // All data will be stored under the generic user ID path
            console.log(`Accessing Firestore path: users/${GENERIC_USER_ID}/${collectionName}`); // Log path
            return db.collection('users').doc(GENERIC_USER_ID).collection(collectionName);
            console.log(`Accessing Firestore path: users/${currentUserId}/${collectionName}`); // Log path
            return db.collection('users').doc(currentUserId).collection(collectionName);
        }

        async function addTransactionToFirestore(transaction) {
            const transactionsRef = getUserCollectionRef('transactions');
            if (!transactionsRef) {
                showToast("Data backend not ready.", 3000);
                return;
            }
            try {
                const dataToAdd = { ...transaction, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                delete dataToAdd.id; // Ensure no local id field is sent if it was accidentally set
                delete dataToAdd.transactionId; // Ensure this hidden input's name is not part of data
                await transactionsRef.add(dataToAdd);
                showToast('Transaction added!');
                resetTransactionForm();
            } catch (error) {
                console.error("Error adding transaction: ", error);
                showToast(`Error adding transaction: ${error.message}`, 5000); // Show error message
            }
        }

        async function updateTransactionInFirestore(transaction) {
            const transactionsRef = getUserCollectionRef('transactions');
            if (!transactionsRef || !transaction.id) {
                showToast("Data backend not ready or missing transaction ID.", 3000);
@@ -668,101 +800,108 @@ function initializeOfflineMode() {
                if (daysDiff < 0) { daysText = `Overdue by ${Math.abs(daysDiff)} day(s)`; daysClass = 'bg-red-100 text-red-600'; }
                else if (daysDiff === 0) { daysText = 'Due Today'; daysClass = 'bg-yellow-100 text-yellow-700'; }
                else if (daysDiff <= 7) { daysText = `In ${daysDiff} day(s)`; daysClass = 'bg-orange-100 text-orange-600'; }
                else { daysText = `In ${daysDiff} days`; }
                const dueDateFormatted = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                li.innerHTML = `
                    <div> <p class="font-medium text-slate-800">${r.description || 'No description'}</p> <p class="text-sm text-slate-500">Due: ${dueDateFormatted}</p> </div>
                    <div class="text-right flex-shrink-0"> <span class="font-medium text-sm ${daysClass} px-2 py-0.5 rounded-full">${daysText}</span>
                        <div class="mt-1 space-x-2">
                            <button onclick="editReminder('${r.id}')" class="action-button edit-button">Edit</button>
                            <button onclick="deleteReminderFromFirestore('${r.id}')" class="action-button delete-button">Delete</button>
                        </div> </div>`;
                reminderListElement.appendChild(li);
            });
        }

        function renderAll() {
            console.log("Rendering UI with current data...");
            renderTransactions();
            renderRecentTransactions();
            renderDashboardBalances();
            renderBudgetAndChart();
            renderReminders();
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo(defaultSection); // Go directly to dashboard
            setupChatbot();
            dateInput.valueAsDate = new Date();

            // --- Setup Firestore Listeners directly for single user ---
            if (db) { // Ensure db is initialized
                // Detach previous listeners if they exist (e.g., from hot reloads)
        function setupFirestoreListeners() {
            if (db && currentUserId) {
                if (unsubscribeTransactions) unsubscribeTransactions();
                if (unsubscribeReminders) unsubscribeReminders();

                const transactionsRef = getUserCollectionRef('transactions');
                if (transactionsRef) {
                    unsubscribeTransactions = transactionsRef.orderBy('date', 'desc')
                        .onSnapshot(snapshot => {
                            transactionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log("Firestore transactions updated via listener:", transactionsData.length);
                            console.log('Firestore transactions updated via listener:', transactionsData.length);
                            renderAll();
                        }, error => {
                            console.error("Error fetching transactions:", error);
                            console.error('Error fetching transactions:', error);
                            showToast(`Error loading transactions: ${error.message}`, 5000);
                            transactionsData = [];
                            renderAll();
                        });
                } else {
                    console.log("Could not get transactionsRef initially.");
                    console.log('Could not get transactionsRef initially.');
                    transactionsData = []; renderAll();
                }

                const remindersRef = getUserCollectionRef('reminders');
                if (remindersRef) {
                    unsubscribeReminders = remindersRef.orderBy('dueDate', 'asc')
                        .onSnapshot(snapshot => {
                            remindersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log("Firestore reminders updated via listener:", remindersData.length);
                            renderReminders(); // Only re-render reminders list
                            console.log('Firestore reminders updated via listener:', remindersData.length);
                            renderReminders();
                        }, error => {
                            console.error("Error fetching reminders:", error);
                            console.error('Error fetching reminders:', error);
                            showToast(`Error loading reminders: ${error.message}`, 5000);
                            remindersData = [];
                            renderReminders();
                        });
                } else {
                    console.log("Could not get remindersRef initially.");
                    console.log('Could not get remindersRef initially.');
                    remindersData = []; renderReminders();
                }
            } else {
                console.error("Firestore (db) is not initialized. Data listeners not set up.");
                showToast("Backend connection error. Data cannot be loaded.", 5000);
                renderAll(); // Attempt to render with empty data
                console.error('Firestore (db) is not initialized or user not logged in. Data listeners not set up.');
                showToast('Backend connection error. Data cannot be loaded.', 5000);
                renderAll();
            }
        }
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo(defaultSection);
            setupChatbot();
            dateInput.valueAsDate = new Date();
            const remembered = loadRemember();
            if (remembered) {
                currentUserId = remembered;
                showApp();
                setupFirestoreListeners();
            } else {
                showAuth();
            }
        });

        transactionForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(transactionForm);
            const transaction = Object.fromEntries(formData.entries());
            transaction.amount = parseFloat(transaction.amount);

            if (!transaction.date) { showToast('Please select a date.', 3000); return; }
            if (isNaN(transaction.amount)) { showToast('Please enter a valid amount.', 3000); return; } // Allow zero amount
            if (transaction.category === 'income' && transaction.amount < 0) { showToast('Income/Payment amount must be positive.', 3000); amountInput.focus(); return; }
            if (transaction.category !== 'income' && transaction.amount > 0) { showToast(`Amount for "${transaction.category.replace(/_/g, ' ')}" should be negative.`, 5000); amountInput.focus(); return; }

            const currentEditingId = transactionIdInput.value;
            if (currentEditingId && editingTransactionId === currentEditingId) {
                transaction.id = currentEditingId;
                updateTransactionInFirestore(transaction);
            } else {
                delete transaction.transactionId; // Ensure hidden input name not saved
                addTransactionToFirestore(transaction);
            }
        });

        reminderForm.addEventListener('submit', (event) => {
@@ -944,26 +1083,26 @@ function initializeOfflineMode() {
    if (!navigator.onLine) {
        console.log('App loaded in offline mode');
        // Don't show toast immediately on load if offline - it's disruptive
        // Instead, just log it and let the app work with cached data
    }
    
    // When an installed PWA launches, check if service worker is ready
    if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('Application launched as PWA');
        
        // If service worker is ready, initialize cache
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            console.log('Service worker controller found - app should work offline');
        } else {
            console.log('No service worker controller - offline functionality may be limited');
            // Don't show toast - this is expected the first time the PWA is launched
        }
    }
}

// Call the function after the page has loaded
window.addEventListener('load', initializeOfflineMode);
    </script>

</body>
</ht
</html>